<?xml version="1.0" encoding="utf-8" ?>
<ContentView
    x:Class="Shaunebu.Controls.Controls.FloatingChatButton"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:Shaunebu.Controls.Converters"
    xmlns:mct="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    x:Name="rootControl">
    <ContentView.Resources>
        <ResourceDictionary>
            <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
            <converters:BoolToAlignmentConverter x:Key="BoolToAlignmentConverter" />
            <converters:BoolToStrokeShapeConverter x:Key="BoolToStrokeShapeConverter" />
            <mct:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        </ResourceDictionary>
    </ContentView.Resources>

    <AbsoluteLayout
        x:Name="absoluteLayout"
        BackgroundColor="Transparent"
        HorizontalOptions="FillAndExpand"
        VerticalOptions="FillAndExpand">

        <!--  Overlay  -->
        <BoxView
            x:Name="overlay"
            AbsoluteLayout.LayoutBounds="0,0,1,1"
            AbsoluteLayout.LayoutFlags="All"
            IsVisible="False"
            Opacity="0"
            ZIndex="0"
            Color="Black" />

        <!--  Floating chat bubble  -->
        <Border
            x:Name="chatBubble"
            Padding="0"
            AbsoluteLayout.LayoutBounds="1,1,60,60"
            AbsoluteLayout.LayoutFlags="None"
            BackgroundColor="{Binding PrimaryColor, Source={x:Reference rootControl}}"
            HeightRequest="60"
            Stroke="Transparent"
            StrokeShape="RoundRectangle 30"
            WidthRequest="60"
            ZIndex="999">
            <Grid>
                <Image
                    Margin="5"
                    Aspect="AspectFit"
                    IsVisible="{Binding IsExpanded, Source={x:Reference rootControl}, Converter={StaticResource InvertedBoolConverter}}"
                    Source="{Binding BotIcon, Source={x:Reference rootControl}}" />
                <Grid
                    x:Name="bubbleContent"
                    Padding="20"
                    IsVisible="{Binding IsExpanded, Source={x:Reference rootControl}}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!--  Messages  -->
                    <CollectionView
                        x:Name="MessagesCollectionView"
                        Grid.Row="0"
                        ItemsSource="{Binding Messages, Source={x:Reference rootControl}}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border
                                    Margin="5"
                                    Padding="10"
                                    BackgroundColor="{Binding IsIncoming, Converter={StaticResource BoolToColorConverter}}"
                                    HorizontalOptions="{Binding IsIncoming, Converter={StaticResource BoolToAlignmentConverter}}"
                                    Stroke="Transparent"
                                    StrokeShape="{Binding IsIncoming, Converter={StaticResource BoolToStrokeShapeConverter}}">
                                    <Label
                                        Text="{Binding Text}"
                                        TextColor="Black"
                                        VerticalOptions="Start" />
                                </Border>

                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!--  Input + button  -->
                    <StackLayout
                        Grid.Row="1"
                        Orientation="Horizontal"
                        Spacing="5">
                        <Entry
                            x:Name="MessageEntry"
                            HorizontalOptions="FillAndExpand"
                            Placeholder="Please type a message..."
                            PlaceholderColor="Black"
                            TextColor="Black" />
                        <Button
                            BackgroundColor="{StaticResource Primary}"
                            CornerRadius="10"
                            Text="Send" />
                    </StackLayout>
                </Grid>

            </Grid>

        </Border>
    </AbsoluteLayout>
</ContentView>